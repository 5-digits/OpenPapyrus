% DEVELOP.TEX
% Copyright (c) A.Sobolev 2010, 2011, 2012, 2014, 2015
% Part of project Papyrus
% Разработка программной системы: принципы и реализация %
%
\documentclass[nobib]{papyrus}
\usepackage{index}
\makeindex
%\usepackage{makeidx}
%
% Титульный лист {
%
\usepackage{CoverPage}

\CoverPageSetup{
	title={Разработка систем Papyrus: принципы и реализация},
	author={},
	copyright={\copyright Петроглиф},
	institute={},
	insource={}
}

\renewcommand{\CoverPageFooterInfo}{
	\parbox[b]{.5\textwidth}{
		\tiny Документ создан: \today
    }
}

\begin{document}

\chapter{Введение}

\chapter{Инструментарий}

\section{Компилятор}

\section{Среда разработки}

\chapter{Базовые типы данных}

Начнем обсуждение разработки с обзора используемых типов данных.
В этой главе мы сосредоточимся на базовых или элементарных типах, которые
применяются как самостоятельно, так и в составе более сложных структур.

\section{Целочисленные типы}

Наиболее простыми и популярными в использовании являются целочисленные
типы данных. 

\subsection{Классификация}

Целочисленные типы классифицируются по следующим двум критериям:

\begin{description}
	\item[Длина] Измеряется в байтах или битах. Типичными вариантами могут быть
	следующие:
	\begin{itemize}
		\item 1 байт
		\item 2 байта
		\item 4 байта
		\item 8 байт
	\end{itemize}
	
	Возможны и другие случаи, но они скорее могут рассматриваться как
	экзотические либо применяемые в узкоспециализированных областях.
	
	\item[Наличие знакового бита]
	Здесь существует только две возможности - либо знаковый бит
	присутствует (это будет самый старший бит в двоичном представлении
	типа), либо он отсутствует.
	
	Беззнаковые (uint) целые типы имеют диапазон 
	представления простирающийся от $0$ до $2^{s}-1$ в то время как
	знаковые (signed) представляют числа от $-(2^{s-1}-1)$ до $2^{s-1}-1$.
	
\end{description}

\subsection{Что мы будем использовать}

Исходя из приведенной классификации, мы можем оперировать набором из 8
целочисленных типов. В действительности их получается несколько больше из-за
того, что некоторые такие типы данных дублируются (по разным причинам, от
исторических до нюансов восприятия).

Мы здесь перечислим те типы которыми будем пользоваться и приведем особенности
их применения:

\begin{description}
	\item[char] Стандарт. Знаковое целое число размером 1 байт. Размер не гарантируется.
	Используется для представления символов в мультибайтовых строках.
	
	\item[uchar] Беззнаковое целое число размером 1 байт. Размер не гарантируется.
	
	\item[wchar\_t] Условный стандарт (зависит от компилятора). Знаковое целое число размером 2 байта. 
	Размер не гарантируется. Используется для представления символов в unicode-строках.
	
	\item[short] Стандарт. Знаковое целое число размером 2 байта. Размер не гарантируется.
	
	\item[ushort] Беззнаковое целое число размером 2 байта. Размер не гарантируется.
	
	\item[int] Стандарт. Знаковое целое число размером 4 байта. Размер не гарантируется.
	Наиболее часто используемый целочисленный тип. Главный недостаток - отсутствие
	гарантии размера. По этому для хранимых (persistent) структур применять не
	рекомендуется, вместо него в этих случаях следует использовать int32.
	
	\item[uint] Беззнаковое целое число размером 4 байта. Размер не гарантируется.
	Чаще всего используется в качестве целочисленного счетчика, поскольку в этом качестве
	процессором	обрабатывается несколько оптимальнее, чем int.
	
	\item[long] Знаковое целое число размером 4 байта. Размер не гарантируется.
	Для 32-битных архитектур аналогичен int.
	
	\item[ulong] Беззнаковое целое число размером 4 байта. Размер не гарантируется.
	
	\item[int8] Знаковое целое число размером 1 байт. Размер гарантируется.
	\item[uint8] Беззнаковое целое число размером 1 байт. Размер гарантируется.
	\item[int16] Знаковое целое число размером 2 байта. Размер гарантируется.
	\item[uint16] Беззнаковое целое число размером 2 байта. Размер гарантируется.
	\item[int32] Знаковое целое число размером 4 байта. Размер гарантируется.
	\item[uint32] Беззнаковое целое число размером 4 байта. Размер гарантируется.
	\item[int64] Знаковое целое число размером 8 байт. Размер гарантируется.
	\item[uint64] Беззнаковое целое число размером 8 байт. Размер гарантируется.
	
	\item[size\_t] Стандарт. Беззнаковое целое число, используемое для представления размера
	участка памяти. 
	
	\item[ssize\_t] Знаковое целое число, используемое для представления размера
	участка памяти. Часто применяется для представления результата вычитания одного адреса
	из другого (если уменьшаемое меньше вычитаемого, то результат будет отрицательным, что
	неприемлемо для стандартного типа size\_t).
\end{description}

\subsection{Аспекты переносимости}

Здесь мы приведем несколько замечаний, касающихся переносимости данных
между различными аппаратными платформами, операционными системами и 
языками программирования.

\subsubsection{Порядок следования байтов}

Разные процессорные архитектуры могут использовать разные соглашения о
порядке следования байтов в двух- и четырех-байтовых целых числах.

Существует два случая:

\begin{description}
	\item[little-endian]
	\item[big-endian]
\end{description}

\subsubsection{Бинарная совместимость с другими языками программирования}

При необходимости обмена бинарными данными между приложениями 
написанных на разных языках программирования может оказаться существенным
выбор типов данных. Так, например, на языке Java не принято оперировать беззнаковыми
целыми типами.

\section{Типы для представления нецелых чисел}

\subsection{Классификация}

Форматы данных для представления нецелых чисел будем классифицировать по следующим критериям:

\begin{description}
	\item[По признаку плавающей точки]
	Дробное число можно представить либо с фиксированной десятичной точкой, либо
	с плавающей.
	
	В первом случае, формат хранения неявно предполагает позицию десятичной точки,
	представляя при этом число фактически в целочисленном виде. Все операции с такими
	числами учитывают положение десятичной точки. Для этого вида представления применяются либо,
	так называемые, двоично-десятичные форматы, либо целочисленные типы, с неявным
	определением положения точки.
	
	Во втором случае формат содержит информацию о положении десятичной точки.
	Такое представление описывается семейством стандартов IEEE 754.
	
	\item[По длине]
	Числа с плавающей точкой (IEEE 754) могут иметь длину 4 или 8 байт.
	
	Двоично-десятичные числа с фиксированной точкой могут иметь, вообще говоря, произвольную 
	длину от 2 байт. Однако, в наших проектах мы чаще всего применяем 8-байтовые величины.
	
	Для чисел с фиксированной точкой в целочисленном формате мы обычно используем 4-байтовые
	целые (int32), с другой стороны, здесь так же нет ограничения для применения 1-, 2-, 8-байтовых
	целых типов (int8, int16, int64).
	
\end{description}

\section{Дата и время}

\subsection{Дата}

В библиотеке SLIB определена специальный тип LDATE, содержащий бинарное
представление даты и необходимые методы для работы с ней.

Вот иллюстрация бинарной структуры типа LDATE:

\begin{verbatim}
	uint16 Year;
	uint8  Month;
	uint8  Day;
\end{verbatim}

Таким образом, видно, что формат занимает 4 байта и использует структурированное
представление даты. Альтернативным для структурированного, является представление,
при котором дата хранится как количество дней, прошедших с какой-то фиксированной
даты.

\paragraph{Специальные значения даты}
	Значение ZERODATE содержит нулевую (пустую) дату.

\subsection{Время}

В библиотеке SLIB определена специальная структура LTIME, содержащая бинарное
представление даты и необходимые методы для работы с ней.

Вот иллюстрация бинарной структуры типа LTIME:

\begin{verbatim}
	uint8  Hour;
	uint8  Minuts;
	uint8  Seconds;
	uint8  HandredthsOfSecond;
\end{verbatim}

Как и LDATE, данный тип занимает в памяти 4 байта.

\paragraph{Специальные значения времени}
	Значение ZEROTIME содержит нулевое время. Заметим, что нулевое время не
	является недопустимым. То есть, 00:00:00 - вполне допустимое значение.
	
\subsection{Дата-время}

Комбинированный тип LDATETIME (определен в SLIB.H) состоит из 8 байт. Старшие 4 байта
заняты типом LDATE, младшие - типом LTIME.

\subsection{Диапазон дат}

Тип DateRange используется для представления диапазона дат. Он состоит из даты
нижней границы диапазона и даты верхней границы.

\begin{verbatim}
	LDATE  low;
	LDATE  upp;
\end{verbatim}

Существуют следующие особенности трактовки границ диапазона:

\begin{itemize}
	\item Если low равно ZERODATE, то нижняя граница не определена.
	\item Если upp равно ZERODATE, то верхняя граница не определена.
	\item Если upp не равно ZERODATE и low > upp, то период считается пустым.
	\ppynote{
		Класс DateRange содержит метод CheckAndSwap(), который меняет местами
		low и upp в таком случае.
	}
\end{itemize}

\section{Строковые типы}

\subsection{SString}

\subsection{SStringU}

\section{Другие типы данных}

\chapter{Базовые структуры данных}

\section{Массив (SArray)}

\section{Коллекция}

\section{Битовый массив (BitArray)}

\section{Набор строк (StringSet)}

\chapter{Доступ к базам данных}

\chapter{Соображения по вопросу неотрицательности товарных остатков}

\chapter{Котировки}

Под котировкой подразумевается некоторое значение (чаще всего, но не обязательно,
имеющее смысл цены), ассоциированное с товаром и, одновременно, сопоставленное с
рядом факторов, от которых зависит применение этой котировки в конкретной ситуации.

Набор факторов на текущий момент выглядит так:

\begin{description}
	\item[Вид котировки] Основной классифицирующий параметр котировки. 
	Справочник видов котировок может содержать произвольное число записей.
	Каждый вид определяет назначение и набор характеристик, влияющих на
	использование котировки.
	
	Один вид зарезервирован - это базовая котировка (идентификатор 1).
	
	Кроме того, существует деление видов котировок на классы. В общем, понятие класса
	котировок необходимо для семантического разделения обычных котировок (обычно представляющих цены) 
	от специализированных (как то, товарная матрица, контрактные цены и т.д.).
	
	\item[Склад]
	Привязка значения котировки к складу обеспечивает дифференциацию по складам.
	
	Здесь важны два следующих нюанса:
	\begin{itemize}
		\item Котировка может быть не привязана ни к какому складу (для всех складов). Такое
		значение имеет меньший приоритет при использовании, нежели котировка, привязанная к
		конкретному складу.
		\item Котировка может быть привязана к группирующему складу. В этом случае существует
		наследование значений по иерархии складов. Так же, как и в предыдущем пункте, более точное
		значение переопределяет менее точное. То есть, значение, заданное для конкретного склада
		имеет больший приоритет, чем значение, заданное для складской группы, содержащей этот склад.
	\end{itemize}
	
	\item[Аналитическая статья]
	
	\item[Валюта]
	
	\item[Минимальное количество]
	
\end{description}

%В этой небольшой главе мы опишем основные изменения, которые претерпела
%техника работы с котировками с системе \ppybrand{}, начиная с версии 7.2.0.

\chapter{Модель объемной оптимизации товарных запасов}

В этой главе я приведу наброски математической модели объемной оптимизации 
товарных запасов.

\section{Модель расчета доходности запаса одного товара}

Первое, что необходимо сделать для объемной оптимизации запасов, это - определить
методику расчета целевой функции по одному товару и необходимые для этого исходные 
данные.

\subsection{Исходные данные для расчета доходности запаса одного товара}

Основные параметры товара, необходимые для расчетов, следующие:

\begin{description}
	\item[ИД товара ($GoodsID$)] Целочисленный уникальный идентификатор товара. 
	
	\item[Себестоимость единицы товара ($c$)] Цена одной единицы товара, 
	которая уплачивается поставщику, либо затрачивается при производстве этого товара.
	Себестоимость может включать прямые издержки на доставку или производство, но 
	не должна содержать издержек на хранение и продажу.
	
	\item[Цена продажи единицы товара ($p$)] Цена, по которой будет продана одна единица
	товара из текущего (рассчитываемого) запаса. Важно что бы эта величина включала (в усредненном
	виде) все возможные скидки, которые могут быть предоставлены покупателям.
	
	\item[Средние ежедневные продажи товара (в торговых единицах) ($D$)]
	Среднее количество торговых единиц товара, которое может быть продано за один день.
\end{description}

Кроме того, на товар могут быть наложены ограничения, связанные с особенностями
поставки, хранения и продажи.

Вот список параметров товара, отражающих такие ограничения:

\begin{description}
	\item[Емкость упаковки поставки в торговых единицах ($Pckg$)]
	Минимальное количество торговых единиц товара, которое может быть закуплено у поставщика.
	Одновременно, данный параметр отражает кратность закупаемой у поставщика (или производимой) 
	партии товара. То есть, модель предполагает, что запасы не могут увеличиваться на величину,
	которая не кратна $Pckg$.
	
	\item[Срок годности в днях ($ExpiryPeriod$)]
	Максимальное количество дней, в течении которых товар может храниться до момента продажи.
	
	\item[Минимальный запас в торговых единицах ($MinStock$)]
	Количество торговых единиц товара, которое обязательно должно быть в запасе.

\end{description}

\subsection{общие параметры модели}

Существует несколько параметров, которые являются общими для всех товаров, обрабатываемых моделью:

\begin{description}
	\item[Норма прибыли в долях единицы ($r$)]
	Один из наиболее важных параметров, используемый для расчета стоимости 
	хранения товарных запасов. Смысл этого значения заключается в оценке минимальной
	доходности инвестиций в товарные запасы.
	Ориентировочно, методика определения величины параметра следующая:
	\begin{itemize}
		\item Рассчитываются годовые издержки на содержание помещения склада (магазина) за прошедший
		год (включая издержки на складское оборудование).
		\item Рассчитываются годовые издержка на заработную плату сотрудникам склада (магазина), 
		непосредственно занятым в хранении и продаже товарных запасов, за прошедший год.
		\item Определяются среднедневные запасы за прошедший год.
		\item Сумма первых двух значений делится на третью величину. В результате получается годовая норма
		издержек на хранение и продажу.
		\item К норме хранения прибавляется рыночная стоимость капитала (средняя банковская процентная ставка на 
		суммы, сопоставимые с себестоимостью среднедневных остатков товаров).
	\end{itemize}
	
	\item[Коэффициент запаса учета срока годности]
	Для того, чтобы модель могла использовать срок годности товаров для ограничения их запасов,
	необходимо правило, определяющее предельный запас независимо от абсолютной даны производства 
	и поступления на склад хранения. 
	Описываемая модель применяет следующее правило: если для товара указан срок годности, то
	максимальный запас должен быть израсходован за период, равный сроку годности, умноженному на
	коэффициент запаса.
	
	Данный коэффициент должен быть больше нуля и меньше или равен единице.

	\item[Максимальная суммарная себестоимость товарных запасов]
	
	\item[Максимальная дневная сумма продаж]
\end{description}

\subsection{Допущения модели}

\begin{itemize}
	\item Весь расход запасов является доходным. То есть модель не рассматривает
	отдельно безвозвратные потери товаров, не приносящие прибыли.
	\item Правомерно применять к расчету показатели бизнеса за предыдущие периоды.
	\item Продажи товаров не интерферируют между собой. Это - одно из самых досадных 
	допущений. В действительности, продажи одного товара влияют на продажи других,
	однако это взаимодействие настолько сложно описать формально, что пришлось ввести
	данное допущение.
	\item Запасы уменьшаются в течении времени линейно пропорционально среднедневным
	продажам ($D$). 
	
	При дальнейшем усложнении модели, вероятно мы введем вероятностные оценки продаж,
	но на первоначальном этапе будем пользоваться наиболее простым правилом.
\end{itemize}

\subsection{Расчет дохода}

Функция дохода рассчитывается как простое произведение запаса на цену реализации.
То есть:

$$
	I = R \cdot p
$$

Обратим внимание на то, что при расчете доходности не учитывается временная стоимость
входящего денежного потока. Причина в том, что временная стоимость полностью учтена 
в функции издержек. Этот нюанс является спорным и, возможно, будет пересмотрен в дальнейшем.

\subsection{Расчет расходов}

Функция расчета расходов более сложная, чем для дохода. Связано это с тем, что расходы
учитывают издержки хранения и продажи, а так же временную стоимость средств, вложенных
в закупку запасов. Вся совокупность описанных издержек \qu{сворачивается} в величине нормы
прибыли $r$.

За предельно малый промежуток времени $dt$, начинающийся с момента $t$ издержки составят:

$$
	dE = c \cdot D \cdot e^{rt} \cdot dt
$$

При интегрировании этой функции за период от $0$ до  $\frac{R}{D}$ получаем:

$$
	E = c \cdot D \cdot \int\limits_0^\frac{R}{D} e^{rt} dt
$$

Что в итоге дает:

$$
	E = c \cdot D \cdot \frac{e^{r\frac{R}{D}} - 1}{r}
$$

\subsection{Расчет оптимального объема запаса}

Функция $f(x) = I - E$ имеет экстремум (максимум). Дифференцируя ее и приравнивая нулю
результат мы можем получить выражение для вычисления оптимального размера запаса:

$$
	R_{opt} = \frac{D}{r}\ln{\frac{p}{c}}
$$

Заметим, что оптимальное значение на много выше того уровня запасов, который
обычно предприятия предпочитают содержать.

\ppyexample{
	Предположим, некоторый товар закупается по цене 16 рублей, а продается по 22 рубля.
	Средний ежедневный спрос на этот товар равен 7. При норме прибыли 50\% годовых
	оптимальный запас этого товара составит 1627 с небольшим единиц и этого запаса
	хватит более чем на 232 дня (едва ли какой-либо магазин или оптовый склад станет
	хранить столь большой объем одного товара хотя бы из-за высокой неопределенности спроса
	в такой временной перспективе).
}

В действительности, рассматриваемая модель не будет стремиться к оптимальному уровню
запасов для каждого товара поскольку ее цель - многопродуктовая оптимизация. То есть,
назначение модели - в нахождении оптимальной с точки зрения прибыльности комбинации множества
товаров с учетом ограничений.

\subsection{Первые результаты}

Уже из всего вышесказанного мы можем получить важные практические результаты. А именно,
наши выкладки для одного товара позволяют определить минимальную наценку на товар при заданном
спросе, либо найти минимальный ежедневный спрос, который необходим для достижения безубыточности
продаж товара, имеющего заданные цены закупа и продажи.

\paragraph{Минимальная наценка}

Величина наценки равна отношению цены продажи к цене закупа. Если наценка ниже минимальной,
то хранение и продажа товара становится не рентабельной.
Для вычисления минимальной наценки необходимо приравнять нулю доходность от одной упаковки товара.

В результате получаем следующее выражение:

$$
	\mu_{min} = \frac{D}{Pckg} \cdot \frac{e^{\frac{r \cdot Pckg}{D}}}{r}
$$

\paragraph{Минимальный спрос}

При заданном значении наценки бывает необходимо определить минимальный требуемый спрос на товара,
при котором рентабельность хранения и продажи еще не отрицательна.

\chapter{Проект SARTR}

Проект SARTR призван реализовать масштабную концепцию компьютерной обработки
естественных языков (NLP).

Важные отличительные черты проекта:

\begin{description}
	\item[Открытость]
	Проект реализуется по лицензии GPL. 
	
	\item[Поддержка любых натуральных языков]
	Предполагается возможность включения в систему словарей и правил для любых
	языков.
	
	\item[Компактность]
	Объемы программного кода и словарей должны быть достаточно малыми для того,
	чтобы функции, реализуемые системой могли быть легко включены в любые инсталлируемые
	приложения.

	\item[Универсальность]
	Система должна обеспечивать большинство утилитарных функций, требуемых приложениям
	общего назначения. Как то: 
	\begin{itemize}
		\item проверка орфографии и синтаксиса
		\item распознавание специфических плохо структурированных строк (адреса, имена, 
		новостные сообщения, наименования товаров и др.)
		\item лексическая трансформация небольших текстов (склонение имен, географических
		названий, общеупотребительных выражений и т.д.)
		\item переводы, и национальная локализация текстов.
	\end{itemize}
	
\end{description}

\section{Сущности}

\begin{itemize}
	\item Лексемы
	\item Трансформации
	\item Понятия (концепции)
	\item Связи
\end{itemize}

\subsection{Лексемы}

Лексемой будем называть устоявшееся слово либо часть слова. 
Кроме того, к лексемам отнесем общепринятые комбинации символов, имеющие
смысл кодов. Например: штрихкод, ip-адрес, почтовый индекс. Многие из этих
кодов в базе данных лексем не хранятся, но распознаются по строго определенным
правилам.

Структура хранения лексемы:

$LEXEM : LEX LEXID$

$LEX$ - текстовое представление лексемы в формате UNICODE

$LEXID$ - числовой идентификатор лексемы в формате беззнакового целого четырехбайтового числа (uint32).

Идентификаторы хранимых лексем не резервируются. То есть все особенности, семантика, правила
трансформации и прочие характеристики лексем определяются либо на основе правил, хранящихся в
базе данных в купе с алгоритмическими механизмами.

Вместе с тем небольшой диапазон идентификаторов резервируется для представления специализированных
лексем (индексы, штрихкоды и другие, которые могут быть алгоритмически идентифицированы с достаточной степенью
достоверности).

Список специализированных лексем:

\begin{description}
	\item[ip-address]
	\item[email-address]
	\item[URL]
	\item[barcode EAN13]
	\item[barcode EAN8]
	\item[barcode UPCA]
	\item[barcode UPCE]
	\item[ИНН (Россия)]
	\item[Почтовый индекс (Россия)]
\end{description}

\subsection{Трансформации}

Трансформация - это правило преобразования начальной формы слова в иную форму.
Например, спряжение глагола, склонение существительного и т.д.

\subsection{Связи}

Связи определяют следующие отношения:

\begin{description}
	\item[Лексема-Лексема] 
	\item[Лексема-Трансформация]
	\item[Лексема-Семантическая сущность]
\end{description}

Структура хранения связи:

$
	LEXLINK: 
		LEXID LEXID SEM
		LEXID 0     TRANSFORM
$

\section{Семантика}

Семантическую классификацию позаимствуем из библиотечных классификаторов.
Примеры есть на ресурсе http://www.innvista.com/society/education/info/classif.htm
Особенно интересны: Dewey Decimal Classification System (www-lib.nearnorth.edu.on.ca/dewey/ddc.htm)

\chapter{Протокол взаимодействия \ppybrand{} и оборудования}

\section{Введение}

Для взаимодействия устройства и \ppybrand{} в драйвере устройства должна быть реализована экспортируемая функция RunCommand (const char  *  pCmd, const char * pInputData, char * pOutputData, size\_t  outSize). В параметре pCmd передается команда в символьном виде, которую должно выполнить устройство. В pInputData -- параметры передаваемой команды. В главе \qu{Основные команды} описаны команды и параметры, которые должны поддерживать все устройства из данного руководства. Также отдельный класс устройств имеет свой набор команд и параметров, о чем подробнее написано в главе \qu{Команды для работы с устройствами}. Получив файл драйвера, необходимо сделать о нем запись в ini-файле каталога \ppybrand{}. Об это подробно написано в главе \qu{Завершающая стадия. Запись в ini-файл}.

\subsection{Экспортируемая функция}
	\paragraph{Синтаксис}
	\begin{description}
		\item[] RunCommand (const char  *  pCmd, const char * pInputData, char * pOutputData, size\_t  outSize)
	\end{description}
	\paragraph{Входные параметры (устанавливает \ppybrand{})}
	\begin{description}
		\item[pCmd]  Имя команды на выполнение.
		\item[pInputData] Перечень параметров, необходимых для выполнения команды. Параметры представляют собой 				пары	\qu{ПАРАМЕТР=значение}, разделенные \qu{\textbf;}.
		\item[outSize] Размер строки pOutputData.
	\end{description}
	\paragraph{Выходные параметры (устанавливает драйвер)}
	\begin{description}
		\item[pOutputData] Результат выполнения команды. Это может быть пустая строка, перечень возвращаемых 					параметров, код ошибки.
	\end{description}
	\paragraph{Возвращаемые значения}
	\begin{description}
		\item[0] Успешное выполнение команды.
		\item[1] Ошибка выполнения команды (в pOutputData передается код ошибки).
		\item[2]  Недостаточный размер выходного буфера pOutputData.
	\end{description}
	\paragraph{Коды ошибок, передаваемые в pOutputData (для некоторых классов устройств существуют дополнительные коды ошибок, которые перечислены в разделах описания этих классов)}
	\begin{description}
		\item[300] Не достаточно параметров для работы устройства.
		\item[301] Передана неизвестная команда.
		\item[302] Ошибка инициализации.
		\item[303] Соединение не установлено.
	\end{description}

\subsection{Порядок взаимодействия \ppybrand{} и устройства}
\paragraph{}На каждую посланную драйверу команду должен прийти ответ.
\paragraph{}Напрмер, \ppybrand{}  отправил команду на соединение
	\begin{description}
		\item[RunCommand («CONNECT», «PORT=1234», pOutputData, outSize).]
	\end{description}
В случае, если команда выполнена успешно, драйвер возвращает код возврата =0 и команду вида:
	\begin{description}
		\item[RunCommand («CONNECT», 0, 0, outSize).]
	\end{description}
Если же возникла ошибка, то драйвер возвращает код =1 и команду вида: 
	\begin{description}
		\item[RunCommand («CONNECT», 0, «303», outSize),]
	\end{description}
где 303 -- код ошибки. Если возникшая ошибка описана в данном руководстве, то передается указанный код. В противном случае, передается тот код, который описан в протоколе устройства.
\paragraph{}\ppybrand{} может запросить описание последней возникшей ошибки. Тогда он отправит команду вида:
	\begin{description}
		\item[RunCommand («GETLASTERRORTEXT», 0, pOutputData, outSize).]
	\end{description}
На это, исходя из предыдущего примера, драйвер ответит командой вида:
	\begin{description}
		\item[RunCommand («GETLASTERRORTEXT», 0, «Соединение не установлено», outSize).]
	\end{description}
Если размера буфера pOutputData, указанного в outSize, не хватает для передачи ответа, то драйвер возвращает код =2.

\section{Команды}

\subsubsection{ОБЩИЕ КОМАНДЫ}
	\begin{description}
		\item[INIT] Команда инициализации устройства. (стр.~\pageref{sub-init})
		\item[RELEASE] Освобождение устройства. Устройство обнуляет все параметры, которые были переданы ему на этапе 			инициализации. (стр.~\pageref{sub-release})
		\item[CONNECT] Команда на установку соединения с устройством. (стр.~\pageref{sub-connect})
		\item[DISCONNECT] Команда на закрытие соединения с устройством. (стр.~\pageref{sub-disconnect})
		\item[SETCONFIG] \ppybrand{} передает устройству пары \qu{ПАРАМЕТР=значение}. (стр.~\pageref{sub-setconfig})
		\item[GETCONFIG] \ppybrand{} запрашивает значения перечисленных параметров. (стр.~\pageref{sub-getconfig})
		\item[GETLASTERRORTEXT] \ppybrand{} запрашивает текст описания последней ошибки. (стр.~\pageref{sub-getlasterrortext})
	\end{description}

\subsubsection{ВЕСЫ}
	\begin{description}
		\item[SENDPLU] Загружает на весы информацию о товаре. (стр.~\pageref{sub-sub-scale-sendplu})
		\item[GETDATA] Получает данные с весов. (стр.~\pageref{sub-sub-scale-getdata})
	\end{description}

\subsubsection{СИНХРОННЫЕ КАССЫ}
	\begin{description}
		\item[CHECKSESSOVER] Проверка на то, что сессия длиться больше 24 часов. (стр.~\pageref{sub-sub-synccash-checksessover})
		\item[XREPORT] Печать X-отчета. (стр.~\pageref{sub-sub-synccash-xreport})
		\item[ZREPORT] Печать Z-отчета. (стр.~\pageref{sub-sub-synccash-zreport})
		\item[OPENBOX] Открыть денежный ящик. (стр.~\pageref{sub-sub-synccash-openbox})
		\item[OPENCHECK] Открыть чек. (стр.~\pageref{sub-sub-synccash-opencheck})
		\item[CLOSECHECK] Закрыть и распечатать чек. (стр.~\pageref{sub-sub-synccash-closecheck})
		\item[PRINTFISCAL] Печать фискальной строки. (стр.~\pageref{sub-sub-synccash-printfiscal})
		\item[PRINTTEXT] Печать текста. (стр.~\pageref{sub-sub-synccash-printtext})
		\item[ANNULATE] Аннулировать документ. (стр.~\pageref{sub-sub-synccash-annulate})
		\item[INCASHMENT] Внесение/изъятие наличности. (стр.~\pageref{sub-sub-synccash-incashment})
		\item[GETCHECKPARAM] Получить параметры текущего документа. (стр.~\pageref{sub-sub-synccash-getcheckparam})
		\item[CLEARSLIPBUF] Отчистить буфер подкладного документа. (стр.~\pageref{sub-sub-synccash-clearslipbuf})
		\item[FILLSLIPBUF] Заполнение буфера подкладного документа строками для печати. (стр.~\pageref{sub-sub-synccash-fillslipbuf})
		\item[PRINTSLIPDOC] Печать подкладного документа. (стр.~\pageref{sub-sub-synccash-printslipdoc})
		\item[GETECRSTATUS] Вернуть статус ККМ (состояние печатающего устройства). (стр.~\pageref{sub-sub-synccash-getecrstatus})
		\item[CONTINUEPRINT] Продолжить печать документа. (стр.~\pageref{sub-sub-synccash-continueprint})
	\end{description}

\subsubsection{PRICE CHECKERS}
	\begin{description}
		\item[SENDBARCODE] Устройство передает Papyrus штрихкод товара. (стр.~\pageref{sub-sub-pricecheckers-sendbarcode})
		\item[PRINTTEXT] Передает на устройство информацию о запрошенном товаре. (стр.~\pageref{sub-sub-pricecheckers-printtext})
		\item[NEXTLINE] Перевести курсор на следующую строку. (стр.~\pageref{sub-sub-pricecheckers-nextline})
		\item[CLEAR] Отчистить экран. (стр.~\pageref{sub-sub-pricecheckers-clear})
		\item[SETPIXELPOS] Установить начальную позицию пикселя текста. (стр.~\pageref{sub-sub-pricecheckers-setpixelpos})
		\item[SETCURSORPOS] Установить начальную позицию курсора. (стр.~\pageref{sub-sub-pricecheckers-setcursorpos})
	\end{description}

\subsubsection{ДИСПЛЕИ ПОКУПАТЕЛЕЙ}
	\begin{description}
		\item[PUTLINE] Вывести текст. При этом указанная строка сначала должна быть очищена самим устройством. 					(стр.~\pageref{sub-sub-customdisplay-putline})
		\item[CLEARDISPLAY] Очистить экран. (стр.~\pageref{sub-sub-customdisplay-cleardisplay})
	\end{description}

\section{Основные команды}

\subsection{INIT}\label{sub-init}
	Команда инициализации устройства.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] В случае успешного выполнения команды - пустая строка, иначе - код ошибки.
	\end{description}

\subsection{RELEASE}\label{sub-release}
Освобождение устройства. Устройство обнуляет все параметры, которые были переданы ему на этапе инициализации.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] В случае успешного выполнения команды - пустая строка, иначе - код ошибки.
	\end{description}

\subsection{CONNECT}\label{sub-connect}
Команда на установку соединения с устройством.
	\paragraph{Входные параметры}
	\begin{description}
		\item[pInputData] PORT и BAUDRATE (номер порта/IP-адрес и скорость обмена). В зависимости от того, к какому классу 			принадлежит устройстово, передается либо один параметр, либо два. Подробнее на стр.~\pageref{sub-sub-scale-connect}, \pageref{sub-sub-synccash-connect}, \pageref{sub-sub-pricecheckers-connect}, \pageref{sub-sub-customdisplay-connect}.
	\end{description}
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] В случае успешного выполнения команды - пустая строка, иначе - код ошибки.
	\end{description}

\subsection{DISCONNECT}\label{sub-disconnect}
Команда на закрытие соединения с устройством.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] В случае успешного выполнения команды - пустая строка, иначе - код ошибки.
	\end{description}

\subsection{SETCONFIG}\label{sub-setconfig}
\ppybrand{} передает устройству пары \qu{ПАРАМЕТР=значение}, которые определены в системе и  соответствуют конкретному классу устройств. Если параметр драйверу устройства не известен, то драйвер пропускает его.
	\paragraph{Входные параметры}
	\begin{description}
		\item[pInputData] Зависит от конкретного класса устройств. Возможные параметры и их значения перечислены в 				разделах описания работы с конкретными устройствами. Подробнее на стр.~\pageref{sub-sub-scale-setconfig}, 					\pageref{sub-sub-synccash-setconfig}.
	\end{description}
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] В случае успешного выполнения команды - пустая строка, иначе - код ошибки.
	\end{description}

\subsection{GETCONFIG}\label{sub-getconfig}
\ppybrand{} запрашивает значения параметров. На этот запрос драйвер должен вернуть все параметры, перечисленные в данном документе в разделе описания работы с данным классом устройств. Возвращаемые параметры перечисляются через \qu{\textbf;} в виде пар \qu{ПАРАМЕТР=значение}.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] В случае успешного выполнения команды пары \qu{ПАРАМЕТР=значение}, иначе - код ошибки. 				Возможные параметры и их значения перечислены в разделах описания работы с конкретными устройствами. 					Подробнее на стр.~\pageref{sub-sub-pricecheckers-getconfig}, \pageref{sub-sub-customdisplay-getconfig}.
	\end{description}

\subsection{GETLASTERRORTEXT}\label{sub-getlasterrortext}
\ppybrand{} запрашивает текст описания последней ошибки.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} 
	\begin{description}
		\item[pOutputData] Текст ошибки.
	\end{description}


\section{Команды для работы с устройствами}
\subsection{\huge{Весы}}
(Возможно, потребуются еще команды и параметры. Пока не совсем ясно где и какие параметры обязательны.)

\subsubsection{\Large{Параметры общих команд}}

\subsubsection{CONNECT}\label{sub-sub-scale-connect}
	\paragraph{Входные параметры}
	\begin{description}
		\item[PORT] (число/строка) Обязательный параметр. Номер COM-порта или IP-адрес.
		\item[BAUDRATE] (число) Обязательный параметр. Скорость обмена. Возможные значения смотри ниже.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра BAUDRATE}
	\begin{description}
		\item[0] Скорость обмена 2400 бод.
		\item[1] Скорость обмена 4800 бод.
		\item[2] Скорость обмена 9600 бод.
		\item[3] Скорость обмена 14400 бод.
		\item[4] Скорость обмена 19200 бод.
		\item[5] Скорость обмена 38400 бод.
		\item[6] Скорость обмена 56000 бод.
		\item[7] Скорость обмена 57600 бод.
		\item[8] Скорость обмена 115200 бод.
		\item[9] Скорость обмена 128000 бод.
		\item[10] Скорость обмена 256000 бод.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
		\item[] RunCommand («CONNECT», «PORT=1234;BAUDRATE=1», pOutputData, outSize)
		\end{description}
	}

\subsubsection{SETCONFIG}\label{sub-sub-scale-setconfig}
	\paragraph{Входные параметры}
	\begin{description}
		\item[LOGNUM]  (число) Обязательный параметр. Логический номер устройства.
		\item[PROTOCOLVER] (число) Обязательный параметр. Версия протокола обмена.
		\item[PREFIXBC] (число) Обязательный параметр. Префикс штрихкода.
		\item[STRIPWP] (число) Обязательный параметр. Игнорировать весовой префикс. Возможные значения смотри ниже.
		\item[READNUMTRIES] (число) Обязательный параметр. Количество попыток чтения из порта.
		\item[READNUMDELAY] (число) Обязательный параметр. Задержка между попытками чтения из порта (мс).
		\item[WRITENUMTRIES] (число) Обязательный параметр. Количество попыток записи в порт.
		\item[WRITENUMDELAY] (число) Обязательный параметр. Задержка между попытками записи в порт (мс).
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра STRIPWP}
	\begin{description}
		\item[0] Не игнорировать префикс.
		\item[1] Игнорировать префикс.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
		\item[] RunCommand («SETCONFIG», «LOGNUM=1; PROTOCOLVER=20; PREFIXBC=7;
		STRIPWP=0; READNUMTRIES=400; READNUMDELAY=5; WRITENUMTRIES=400; 
		WRITENUMDELAY=5», pOutputData, outSize)
		\end{description}
	}

\subsubsection{\Large{Дополнительные команды}}

\subsubsection{SENDPLU}\label{sub-sub-scale-sendplu}
	Загружает на весы информацию о товаре.
	\paragraph{Входные параметры}
	\begin{description}
		\item[GOODNUMBER] (число) Обязательный параметр. Номер товара.
		\item[GROUPCODE] (число) Обязательный параметр. Номер группы товаров.
		\item[GOODNAME] (строка) Обязательный параметр. Наименование товара. (кодировка CP886)
		\item[PRICE] (число) Обязательный параметр. Цена реализации товара в копейках.
		\item[EXPIRY] (строка) Обязательный параметр. Дата окончания срока годности в формате дд.мм.гг.
		\item[BARCODE] (число) Обязательный параметр. Штрихкод.
		\item[ADDMESSAGE] (строка) Необязательный параметр. Дополнительная информация о товаре. (кодировка CP886)
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («SENDPLU», «GOODNUMBER=12; GROUPCODE=1; GOODNAME=Конфеты 									"Белочка"; PRICE=6400; EXPIRY=12.12.12; BARCODE=123456789», pOutputData, outSize)
		\end{description}
	}

\subsubsection{GETDATA}\label{sub-sub-scale-getdata}
	Получает данные с весов.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры}
	\begin{description}
		\item[GOODNUMBER] (число) Обязательный параметр. Номер товара.
		\item[WEIGHT] (число) Обязательный параметр. Вес товара в граммах.
	\end{description}
	\ppyexample{
		\paragraph{ Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («GETDATA», 0, pOutputData, outSize)
		\end{description}
		\paragraph{Драйвер отвечает:}
		\begin{description}
			\item[] RunCommand («GETDATA», 0, «GOODNUMBER=12; WEIGHT=450», outSize)
		\end{description}
	}

\paragraph{}
\paragraph{}

\subsection{\huge{Синхронные кассы}}

\subsubsection{\Large{Параметры общих команд}}

\subsubsection{CONNECT}\label{sub-sub-synccash-connect}
	\paragraph{Входные параметры}
	\begin{description}
		\item[PORT] (число) Обязательный параметр. Номер COM-порта.
		\item[BAUDRATE] (число) Обязательный параметр. Скорость обмена. Возможные значения смотри ниже.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра BAUDRATE}
	\begin{description}
		\item[0] Скорость обмена 2400 бод.
		\item[1] Скорость обмена 4800 бод.
		\item[2] Скорость обмена 9600 бод.
		\item[3] Скорость обмена 14400 бод.
		\item[4] Скорость обмена 19200 бод.
		\item[5] Скорость обмена 38400 бод.
		\item[6] Скорость обмена 56000 бод.
		\item[7] Скорость обмена 57600 бод.
		\item[8] Скорость обмена 115200 бод.
		\item[9] Скорость обмена 128000 бод.
		\item[10] Скорость обмена 256000 бод.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CONNECT», «PORT=1234; BAUDRATE=1», pOutputData, outSize)
		\end{description}
	}

\subsubsection{SETCONFIG}\label{sub-sub-synccash-setconfig}
	\paragraph{Входные параметры}
	\begin{description}
		\item[LOGNUM] (число) Обязательный параметр. Логический номер устройства.
		\item[AUTOCASHNULL] (число) Обязательный параметр. Автоматическое обнуление наличности. Возможные значения 				смотри ниже.
		\item[SESSIONID] (число) Обязательный параметр. Номер текущей сессии.
		\item[CSHRNAME] (строка) Обязательный параметр. Имя кассира. (кодировка CP886)
		\item[ADMINNAME] (строка) Обязательный параметр. Имя администратора. (кодировка CP886)
		\item[ADMINPASSWORD] (строка) Обязательный параметр. Пароль администратора. (кодировка CP886)
		\item[FLAGS] (число) Обязательный параметр. Флаги. Передаются в десятичном виде. Возможные значения смотри 				ниже.
		\item[PRINTLOGO] (число) Обязательный параметр. Печатать логотип. Возможные значения смотри ниже.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра AUTOCASHNULL}
	\begin{description}
		\item[0] Не обнулять.
		\item[1] Обнулять.
	\end{description}
	\paragraph{Значения параметра FLAGS}
	\begin{description}
		\item[0x00000008] Не активировать первую строку чека.
		\item[0x00000010] Открывать денежный ящик при пробивке чека.
		\item[0x00000100] Округлять в чеке \% скидки до целого.
		\item[0x08000000] Не использовать отрезчик чеков.
	\end{description}
	\paragraph{Значения параметра PRINTLOGO}
	\begin{description}
		\item[0] Не печатать логотип на документах.
		\item[1] Печатать логотип.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («SETCONFIG», «LOGNUM=1; SESSIONID=2; AUTOCASHNULL=1;  									CSHRNAME=Кассир; ADMINNAME=Старший кассир; ADMINPASSWORD=Пароль; 
			FLAGS=24; PRINTLOGO=0», pOutputData, outSize)
		\end{description}
	}

\subsubsection{\Large{Дополнительные команды}}

\subsubsection{CHECKSESSOVER}\label{sub-sub-synccash-checksessover}
	Проверка на то, что сессия длиться больше 24 часов.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры}
	\begin{description}
		\item[0] Cессия длится меньше 24 часов.
		\item[1] Cессия длится больше 24 часов.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CHECKSESSOVER», 0, pOutputData, outSize)
		\end{description}
		\paragraph{Драйвер отвечает:}
		\begin{description}
			\item[] RunCommand («CHECKSESSOVER», 0, «0» (или «1»), outSize)
		\end{description}
	}

\subsubsection{XREPORT}\label{sub-sub-synccash-xreport}
	Печать X-отчета.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («XREPORT», 0, pOutputData, outSize)
		\end{description}
	}

\subsubsection{ZREPORT}\label{sub-sub-synccash-zreport}
	Печать Z-отчета.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («ZREPORT», 0, pOutputData, outSize)
		\end{description}
	}

\subsubsection{OPENBOX}\label{sub-sub-synccash-openbox}
	Открыть денежный ящик.
	\paragraph{Входные параметры}
	\begin{description}
 		\item[DRAWERNUM] (число) Обязательный параметр. Номер денежного ящика.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
 			\item[] RunCommand («OPENBOX», «DRAWERNUM=1», pOutputData, outSize)
		\end{description}
	}

\subsubsection{OPENCHECK}\label{sub-sub-synccash-opencheck}
	Открыть чек.
	\paragraph{Входные параметры}
	\begin{description}
 		\item[CHECKTYPE] (число) Обязательный параметр. Тип документа. Возможные значения смотри ниже.
 		\item[CHECKNUM] (число) Обязательный параметр. Текущий номер документа.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра CHECKTYPE}
	\begin{description}
 		\item[0] Сервисный.
 		\item[1] Чек на продажу.
 		\item[2] Чек на возврат.
 		\item[3] Внесение в кассу.
 		\item[4] Изъятие наличности.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («OPENCHECK», «CHECKTYPE=1; CHECKNUM=12», pOutputData, outSize)
		\end{description}
	}

\subsubsection{CLOSECHECK}\label{sub-sub-synccash-closecheck}
	Закрыть и распечатать чек.
	\paragraph{Входные параметры}
	\begin{description}
 		\item[PAYMCASH] (число) Сумма наличных, принятая от покупателя в рублях (при этом количество знаков после 				десятичной точки может быть любым).
		\item[PAYMCARD] (число) Сумма по карте, принятая от покупателя в рублях (при этом количество знаков после 				десятичной точки может быть любым).
	\end{description}
	Обязательно использование хотя бы одного параметра. В случае, если оплата произведена и по карте и наличными, то 			передаются оба параметра.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CLOSECHECK», «PAYMCASH=10.5», pOutputData, outSize)
		\end{description}
	}

\subsubsection{PRINTFISCAL}\label{sub-sub-synccash-printfiscal}
	Печать фискальной строки.
	\paragraph{Входные параметры}
	\begin{description}
 		\item[RIBBONPARAM] (число) Обязательный параметр. На какой носитель печатать. Возможные значения смотри ниже.
		\item[DEPARTMENT]  (число) Обязательный параметр. Номер отдела.
		\item[QUANTITY] (число) Обязательный параметр. Количество товара в товарной позиции.
		\item[PRICE] (число) Обязательный параметр. Цена реализации товара в рублях (при этом количество знаков после 				десятичной точки может быть любым).
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра RIBBONPARAM}
	\begin{description}
 		\item[0] Чековая лента.
 		\item[1] Контрольная чековая лента.
 		\item[2] Фискальная память.
 		\item[3] Подкладной документ.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («PRINTFISCAL», «RIBBONPARAM=0; DEPARTMENT=1; QUANTITY=5; PRICE=10», pOutputData, 				outSize)
		\end{description}
	}

\subsubsection{PRINTTEXT}\label{sub-sub-synccash-printtext}
	Печать текста.
	\paragraph{Входные параметры}
	\begin{description}
 		\item[RIBBONPARAM] (число) Обязательный параметр. На какой носитель печатать. Возможные значения смотри ниже.
 		\item[TEXT] (строка) Обязательный параметр. Строка, которую нужно напечатать. (кодировка CP886)
 		\item[FONTSIZE] (число) Обязательный параметр. Номер шрифта. Возможные значения смотри ниже.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра RIBBONPARAM}
	\begin{description}
 		\item[0] Чековая лента.
 		\item[1] Контрольная чековая лента.
 		\item[2] Фискальная память.
 		\item[3] Подкладной документ.
	\end{description}
	\paragraph{Значения параметра FONTSIZE}
	\begin{description}
 		\item[1] Очень мелкий.
 		\item[2] Мелкий.
 		\item[3] Средний.
 		\item[4] Крупный.
 		\item[5] Очень крупный.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («PRINTTEXT», «RIBBONPARAM=0; TEXT="Скидка 5\%"; FONTSIZE=3», pOutputData, outSize)
		\end{description}
	}

\subsubsection{ANNULATE}\label{sub-sub-synccash-annulate}
	Аннулировать документ.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («ANNULATE», 0, pOutputData, outSize)
		\end{description}
	}

\subsubsection{INCASHMENT}\label{sub-sub-synccash-incashment}
	Внесение/изъятие наличности.
	\paragraph{Входные параметры}
	\begin{description}
 		\item[AMOUNT] (число)  Обязательный параметр. Сумма изъятия/внесения в рублях (при этом количество знаков после 			десятичной точки может быть любым).
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («INCASHMENT», «AMOUNT=5000.55»,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{GETCHECKPARAM}\label{sub-sub-synccash-getcheckparam}
	Получить параметры текущего документа.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} 
	\begin{description}
 		\item[CASHAMOUNT] (число) Обязательный параметр. Сумма наличности в кассе в рублях (при этом количество знаков 			после десятичной точки может быть любым).
 		\item[RIBBONPARAM] (число) Обязательный параметр. Какой носитель выбран для печати. Возможные значения смотри 		ниже.
 		\item[CHECKNUM] (число) Обязательный параметр. Текущий номер документа.
	\end{description}
	\paragraph{Значения параметра RIBBONPARAM} 
	\begin{description}
 		\item[0] Чековая лента.
 		\item[1] Контрольная чековая лента.
 		\item[2] Фискальная память.
 		\item[3] Подкладной документ.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («GETCHECKPARAM», 0,  pOutputData, outSize)
		\end{description}
		\paragraph{Драйвер отвечает:}
		\begin{description}
			\item[] RunCommand («GETCHECKPARAM», «CASHAMOUNT=55.25; RIBBONPARAM=0; CHECKNUM=1»,  pOutputData, 				outSize)
		\end{description}
	}

\subsubsection{CLEARSLIPBUF}\label{sub-sub-synccash-clearslipbuf}
	Отчистить буфер подкладного документа.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CLEARSLIPBUF», 0,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{FILLSLIPBUF}\label{sub-sub-synccash-fillslipbuf}
	Заполнение буфера подкладного документа строками для печати.
	\paragraph{Входные параметры} 
	\begin{description}
 		\item[STRNUM] (число)  Обязательный параметр. Номер строки подкладного документа.
 		\item[TEXT] (строка) Обязательный параметр. Строка, которую нужно напечатать. (кодировка CP886)
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («FILLSLIPBUF», «STRNUM=1; TEXT=Печать документа»,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{PRINTSLIPDOC}\label{sub-sub-synccash-printslipdoc}
	Печать подкладного документа.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («PRINTSLIPDOC», 0,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{GETECRSTATUS}\label{sub-sub-synccash-getecrstatus}
	Вернуть статус ККМ (состояние печатающего устройства).
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры}
	\begin{description}
 		\item[STATUS] (число) Обязательный параметр. Флаг статуса ККМ. Передается в десятичном формате. Возможные 				значения сморти ниже.
	\end{description}
	\paragraph{Значения параметра STATUS}
	\begin{description}
 		\item[0x00] Нет печати.
 		\item[0x01] Нет бумаги.
 		\item[0x02] Ожидание команды на продолжение печати.
 		\item[0x04] Режим печати.
 		\item[0x08] Открыт чек.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («GETECRSTATUS», 0,  pOutputData, outSize)
		\end{description}
		\paragraph{Драйвер отвечает:}
		\begin{description}
			\item[] RunCommand («GETECRSTATUS», «STATUS=9»,  pOutputData, outSize)
		\end{description}
		\begin{description}
			\item[STATUS=9] Значит, что открыт чек и в принтере нет бумаги.
		\end{description}
	}

\subsubsection{CONTINUEPRINT}\label{sub-sub-synccash-continueprint}
	Продолжить печать документа.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CONTINUEPRINT», 0,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{Дополнительные коды ошибок}
	Ниже перечислены специфические ошибки, коды которых должен знать драйвер. В случае возникновения, код ошибки 			передается в pOutputData.
	\begin{description}
 		\item[400] Буфер подкладного документа пуст.
 		\item[401] Некорректное состояние ЭКЛЗ.
 		\item[402] ЭКЛЗ или ФП переполнена.
 		\item[403] Ошибка ЭКЛЗ. Просьба обратиться в ЦТО.
	\end{description}

\paragraph{}
\paragraph{}

\subsection{\huge{Price Checkers}}

\subsubsection{\Large{Основные команды}}

\subsubsection{CONNECT}\label{sub-sub-pricecheckers-connect}
	\paragraph{Входные параметры} 
	\begin{description}
		\item[PORT] (строка) Обязательный параметр. IP-адрес.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CONNECT», «PORT=127.0.0.1»,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{GETCONFIG}\label{sub-sub-pricecheckers-getconfig}
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры}
	\begin{description}
		\item[DISPLAYWIDTH] (число) Обязательный параметр. Ширина дисплея в пикселях.
		\item[DISPLAYHEIGHT] (число) Обязательный параметр.  Высота дисплея в пикселях.
		\item[LINECOUNT] (число) Обязательный параметр. Число строк, которое можно вывести на дисплей.
		\item[SYMBCOUNT] (число) Обязательный параметр. Количество символов в строке.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («GETCONFIG», 0,  pOutputData, outSize)
		\end{description}
		\paragraph{Драйвер отвечает:}
		\begin{description}
			\item[] RunCommand («GETCONFIG», «DISPLAYWIDTH=200; DISPLAYHEIGHT=50; LINECOUNT=2; SYMBCOUNT=20», 				pOutputData, outSize)
		\end{description}
	}

\subsubsection{\Large{Дополнительные команды}}

\subsubsection{SENDBARCODE}\label{sub-sub-pricecheckers-sendbarcode}
	Устройство передает \ppybrand{} штрихкод товара. После установки соединения \ppybrand{} будет ожидать эту команду.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры}
	\begin{description}
		\item[BARCODE] (число) Обязательный параметр. Штрихкод товара.
	\end{description}
	\ppyexample{
		\paragraph{Драйвер посылает:}
		\begin{description}
			\item[] RunCommand («SENDBARCODE», 0,  «BARCODE=132456789», outSize)
		\end{description}
	}

\subsubsection{PRINTTEXT}\label{sub-sub-pricecheckers-printtext}
	Передает на устройство информацию о запрошенном товаре.
	\paragraph{Входные параметры} 
	\begin{description}
		\item[TEXT] (строка) Обязательный параметр. Текст, описывающий товар. (кодировка CP886)
		\item[ALIGN] (число) Обязательный параметр. Выравнивание текста. Возможные значения смотри ниже.
		\item[FONT] (число) Обязательный параметр. Номер шрифта. Возможные значения смотри ниже.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра ALIGN} 
	\begin{description}
		\item[1] Слева вверху.
		\item[2] По центру вверху.
		\item[3] Справа вверху.
		\item[4] Слева по центру.
		\item[5] По центру.
		\item[6] Справа по центру.
		\item[7] Слева снизу.
		\item[8] Слева по центру.
		\item[9] Справа снизу.
		\item[10] Слева на текущей строке.
		\item[11] По центру на текущей строке.
		\item[12] Справа на текущей строке.
		\item[13] Сверху на текущей X-координате.
		\item[14] По центру на текущей X-координате.
		\item[15] Снизу на текущей X-координате.
		\item[16] Текущая позиция.
	\end{description}
	\paragraph{Значения параметра FONT} 
	\begin{description}
		\item[1] Очень мелкий.
		\item[2] Мелкий.
		\item[3] Средний.
		\item[4] Крупный.
		\item[5] Очень крупный.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («PRINTTEXT», «TEXT=Кофеты "Лакомка" ВЕС 200 гр; ALIGN=0; FONT=1»,  pOutputData, 					outSize)
		\end{description}
	}

\subsubsection{NEXTLINE}\label{sub-sub-pricecheckers-nextline}
	Перевести курсор на начало следующей строки.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («NEXTLINE», 0,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{CLEAR}\label{sub-sub-pricecheckers-clear}
	Отчистить экран.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CLEAR», 0,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{SETPIXELPOS}\label{sub-sub-pricecheckers-setpixelpos}
	Установить позицию пикселя текста.
	\paragraph{Входные параметры} 
	\begin{description}
		\item[XCOORD] (число) Обязательный параметр. Номер пикселя по горизонтали.
		\item[YCOORD] (число) Обязательный параметр. Номер пикселя по вертикали.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («SETPIXELPOS», «XCOORD=20; YCOORD=1»,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{SETCURSORPOS}\label{sub-sub-pricecheckers-setcursorpos}
	Установить позицию курсора.
	\paragraph{Входные параметры} 
	\begin{description}
		\item[XCOORD] (число) Обязательный параметр. Номер позиции в строке.
		\item[YCOORD] (число) Обязательный параметр. Номер строки.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («SETCURSORPOS», «XCOORD=20; YCOORD=1»,  pOutputData, outSize)
		\end{description}		
	}

\paragraph{}
\paragraph{}

\subsection{\huge{Дисплеи покупателей}}

\subsubsection{\Large{Основные команды}}

\subsubsection{CONNECT}\label{sub-sub-customdisplay-connect}
	\paragraph{Входные параметры} 
	\begin{description}
		\item[PORT] (число) Обязательный параметр. Номер COM-порта.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CONNECT», «PORT=1234»,  pOutputData, outSize)
		\end{description}
	}

\subsubsection{GETCONFIG}\label{sub-sub-customdisplay-getconfig}
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры}
	\begin{description}
		\item[STRLEN] (число) Обязательный параметр. Ширина строки в символах.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («GETCONFIG», 0,  pOutputData, outSize)
		\end{description}
		\paragraph{Драйвер отвечает:}
		\begin{description}
			\item[] RunCommand («GETCONFIG», «STRLEN=20», pOutputData, outSize)
		\end{description}
	}

\subsubsection{\Large{Дополнительные команды}}

\subsubsection{PUTLINE}\label{sub-sub-customdisplay-putline}
	Вывести текст. При этом указанная строка сначала должна быть очищена самим устройством.
	\paragraph{Входные параметры} 
	\begin{description}
		\item[TEXT] (строка) Обязательный параметр. Текст для вывода на экран. (кодировка CP886)
		\item[VERTAB] (число) Обязательный параметр. Переместить курсор по вертикали. Возможные значения смотри ниже.
		\item[ALIGN ] (число) Обязательный параметр. Выравнивание по горизонтали. Возможные значения смотри ниже.
	\end{description}
	\paragraph{Выходные параметры} Отсутствуют.
	\paragraph{Значения параметра VERTAB} 
	\begin{description}
		\item[0] На строку вверх.
		\item[1] На строку вниз.
		\item[2] Текущая позиция.
	\end{description}
	\paragraph{Значения параметра ALIGN} 
	\begin{description}
		\item[0] Cлева.
		\item[1] Cправа.
		\item[2] По центру.
		\item[3] Текущая позиция.
	\end{description}
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («PUTLINE», «TEXT=Конфеты "Лакомка"; VERTAB=3; ALIGN=1», pOutputData, outSize)
		\end{description}
	}

\subsubsection{CLEARDISPLAY}\label{sub-sub-customdisplay-cleardisplay}
	Очистить экран.
	\paragraph{Входные параметры} Отсутствуют.
	\paragraph{Выходные параметры} Отсутствуют.
	\ppyexample{
		\paragraph{Papyrus посылает:}
		\begin{description}
			\item[] RunCommand («CLEARDISPLAY», 0, pOutputData, outSize)
		\end{description}
	}

\section{Завершающая стадия. Запись в ini-файл}
Получив файл драйвера устройства с экспортируемой функцией RunCommand(), необходимо поместить его в каталог PPY/BIN/DRV/ и отметить в файле ppdrv.ini, который находится в каталоге PPY/BIN/. Формат записи следующий:
\begin{description}
	\item[идентификатор=имя\_для\_отображения,тип\_файла\_драйвера,имя\_файла\_с\_расширением]
\end{description}
Между элементами записи не должно быть пробелов.
\paragraph{}Запись нужно сделать в соответствующей группе устройств. Название группы написано в квадратных скобках. Пояснение к названиям смотри ниже.
\paragraph{}К примеру, так запись будет выглядеть для dll-файла синхронной ККМ \qu{ПИРИТ}:
	\ppyexample{
		\paragraph{} [SyncPOS]
		\paragraph{} ...
		\paragraph{} pirit-petrogl=DRV:Пирит (Петроглиф),dll,Pirit.dll
		\paragraph{} ...
	}
В примере:
\begin{description}
	\item[SyncPOS] Запись сделана в  группе устройств \qu{синхронные ККМ}.
	\item[pirit-petrogl] Идентификатор.
	\item[DRV:Пирит (Петроглиф)] Строка, которая будет отображаться в \ppybrand{} для идентификации устройства.
	\item[dll] Тип файла драйвера.
	\item[Pirit.dll] Имя файла драйвера с расширением.
\end{description}
\paragraph{Группы устройств}
\begin{description}
	\item[SyncPOS] Синхронные ККМ.
	\item[AsyncPOS] Асинхронные ККМ.
	\item[Scale] Весы.
	\item[CustomDisplay] Дисплеи покупателей.
\end{description}

\chapter{Зарезервированные объекты}

\section{Universe-HTT}

Глобальная учетная запись администрирования устройств Stylo на Universe-HTT: stylo-common@uhtt.ru eMiKi5G66ah-AZB

\subsection{Необходимые настройки в базе данных Papyrus на сервере Universe-HTT}

\paragraph{Товары и товарные группы}

Товарная группа \ppyrsrv{Special Items}: наименование не важно, код не важен. В эту группу заносятся товары, необходимые для функционирования сервера.

Тарифицирующие товары группы \ppyrsrv{Special Items} необходимы для идентификации стоимости тарификации той или иной клиентской операции.
В этих товарах важен код. Формат кода: GTA[0-9]+.

\begin{description}
	\item[GTA001] \ppyrsrv{Gta objget}. Общий тариф доступа к объектам данных. Фактически не используется. Для регламентации стоимости
	доступа к конкретным типам объектов необходим товар с кодом GTA001[OBJTYPEID] где OBJTYPEID - идентификатор типа объекта.
	Например, для тарификации доступа к товарам применяется специальный товар GTA0011009
	
\end{description}

\paragraph{Персональные отношения}

\begin{description}
	\item[Управляющая персоналия] Символ \ppyrsrv{UHTT\_PSNREL\_MASTER}. Определяет отношение от персоналии - владельца аккаунта к поставщикам.
\end{description}

\chapter{Регламентированные задания}
	\paragraph{Проверка работоспособности}
		\begin{enumerate}
			\item petroglif.ru
			\item uhtt.ru
			\item forum.petroglif.ru
			\item papyrus
		\end{enumerate}
		\begin{description}	
		\item Отчёт о проверке: \verb|D:\Papyrus\Src\Doc\TasksReport.xlsx|
	\end{description}

\end{document}